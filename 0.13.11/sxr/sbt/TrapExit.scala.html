<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/TrapExit.scala</title>
        <script type="text/javascript" src="../jquery-all.js"></script>
        <script type="text/javascript" src="../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/* sbt -- Simple Build Tool
 * Copyright 2008 Mark Harrah
 *
 * Partially based on exit trapping in Nailgun by Pete Kirkham,
 * copyright 2004, Martian Software, Inc
 * licensed under Apache 2.0 License.
 */</span>
<span class="keyword">package</span> sbt

<span class="keyword">import</span> scala.collection.Set
<span class="keyword">import</span> scala.reflect.Manifest
<span class="keyword">import</span> scala.collection.concurrent.TrieMap

<span class="keyword">import</span> java.lang.ref.WeakReference
<span class="keyword">import</span> <span title="Thread.type">Thread</span>.currentThread
<span class="keyword">import</span> java.security.Permission
<span class="keyword">import</span> java.util.concurrent.<span class="delimiter">{</span> ConcurrentHashMap =&gt; CMap <span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.<span title="Integer.type">Integer</span>.<span class="delimiter">{</span> toHexString =&gt; hex <span class="delimiter">}</span>
<span class="keyword">import</span> java.lang.<span title="Long.type">Long</span>.<span class="delimiter">{</span> toHexString =&gt; hexL <span class="delimiter">}</span>

<span class="keyword">import</span> <a href="#sbt.TrapExit" title="sbt.TrapExit.type">TrapExit</a>._

<span class="comment">/**
 * Provides an approximation to isolated execution within a single JVM.
 * System.exit calls are trapped to prevent the JVM from terminating.  This is useful for executing
 * user code that may call System.exit, but actually exiting is undesirable.
 *
 * Exit is simulated by disposing all top-level windows and interrupting user-started threads.
 * Threads are not stopped and shutdown hooks are not called.  It is
 * therefore inappropriate to use this with code that requires shutdown hooks, creates threads that
 * do not terminate, or if concurrent AWT applications are run.
 * This category of code should only be called by forking a new JVM.
 */</span>
<span class="keyword">object</span> <a title="sbt.TrapExit.type" id="sbt.TrapExit">TrapExit</a> <a href="#sbt.TrapExit" title="sbt.TrapExit.type" class="delimiter">{</a>
  <span class="comment">/**
   * Run `execute` in a managed context, using `log` for debugging messages.
   * `installManager` must be called before calling this method.
   */</span>
  <span class="keyword">def</span> <a title="(execute: =&gt; Unit, log: sbt.Logger)Int" id="sbt.TrapExit.apply">apply</a><span class="delimiter">(</span><a title="=&gt; Unit" id="sbt.TrapExit.apply.execute">execute</a>: =&gt; Unit, <a title="sbt.Logger" id="sbt.TrapExit.apply.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <span title="System.type">System</span>.<span title="()SecurityManager">getSecurityManager</span> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="sbt.TrapExit" id="sbt.TrapExit.apply.m">m</a>: <a href="#sbt;TrapExit" title="sbt.TrapExit">TrapExit</a> =&gt; <a href="#sbt.TrapExit.apply.m" title="sbt.TrapExit">m</a>.<a href="#sbt;TrapExit.runManaged" title="(f: xsbti.F0[Unit], xlog: xsbti.Logger)Int">runManaged</a><span class="delimiter">(</span><a href="Logger.scala.html#sbt.Logger" title="sbt.Logger.type">Logger</a>.<a href="Logger.scala.html#sbt.Logger.f0" title="(t: =&gt; Unit)xsbti.F0[Unit]">f0</a><span class="delimiter">(</span><a href="#sbt.TrapExit.apply.execute" title="=&gt; Unit">execute</a><span class="delimiter">)</span>, <a href="#sbt.TrapExit.apply.log" title="sbt.Logger">log</a><span class="delimiter">)</span>
      <span class="keyword">case</span> _           =&gt; <a href="#sbt.TrapExit.runUnmanaged" title="(execute: =&gt; Unit, log: sbt.Logger)Int">runUnmanaged</a><span class="delimiter">(</span><a href="#sbt.TrapExit.apply.execute" title="=&gt; Unit">execute</a>, <a href="#sbt.TrapExit.apply.log" title="sbt.Logger">log</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">/**
   * Installs the SecurityManager that implements the isolation and returns the previously installed SecurityManager, which may be null.
   * This method must be called before using `apply`.
   */</span>
  <span class="keyword">def</span> <a title="()SecurityManager" id="sbt.TrapExit.installManager">installManager</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="SecurityManager">SecurityManager</span> =
    <span title="System.type">System</span>.<span title="()SecurityManager">getSecurityManager</span> <span title="SecurityManager" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="sbt.TrapExit">m</span>: <a href="#sbt;TrapExit" title="sbt.TrapExit">TrapExit</a> =&gt; <span title="sbt.TrapExit">m</span>
      <span class="keyword">case</span> <span title="SecurityManager">m</span>           =&gt; <span title="System.type">System</span>.<span title="(x$1: SecurityManager)Unit">setSecurityManager</span><span class="delimiter">(</span><span title="sbt.TrapExit" class="keyword">new</span> <a href="#sbt;TrapExit" title="sbt.TrapExit">TrapExit</a><span class="delimiter">(</span><span title="SecurityManager">m</span><span class="delimiter">)</span><span class="delimiter">)</span>; <span title="SecurityManager">m</span>
    <span class="delimiter">}</span>

  <span class="comment">/** Uninstalls the isolation SecurityManager and restores the old security manager. */</span>
  <span class="keyword">def</span> <a title="(previous: SecurityManager)Unit" id="sbt.TrapExit.uninstallManager">uninstallManager</a><span class="delimiter">(</span><a title="SecurityManager" id="sbt.TrapExit.uninstallManager.previous">previous</a>: <span title="SecurityManager">SecurityManager</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <span title="System.type">System</span>.<span title="(x$1: SecurityManager)Unit">setSecurityManager</span><span class="delimiter">(</span><a href="#sbt.TrapExit.uninstallManager.previous" title="SecurityManager">previous</a><span class="delimiter">)</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(execute: =&gt; Unit, log: sbt.Logger)Int" id="sbt.TrapExit.runUnmanaged">runUnmanaged</a><span class="delimiter">(</span><a title="=&gt; Unit" id="sbt.TrapExit.runUnmanaged.execute">execute</a>: =&gt; Unit, <a title="sbt.Logger" id="sbt.TrapExit.runUnmanaged.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <span class="delimiter">{</span>
      <a href="#sbt.TrapExit.runUnmanaged.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.warn(83d3728a3c)" title="(message: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="String(&quot;Managed execution not possible: security manager not installed.&quot;)" class="string">&quot;Managed execution not possible: security manager not installed.&quot;</span><span class="delimiter">)</span>
      <span class="keyword">try</span> <span class="delimiter">{</span> <a href="#sbt.TrapExit.runUnmanaged.execute" title="=&gt; Unit">execute</a>; <span title="Int(0)" class="int">0</span> <span class="delimiter">}</span>
      <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Exception" id="sbt.TrapExit.runUnmanaged.e">e</a>: <span title="Exception">Exception</span> =&gt;
          <a href="#sbt.TrapExit.runUnmanaged.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.error(83d3728a3c)" title="(message: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error during execution: &quot;)" class="string">&quot;Error during execution: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt.TrapExit.runUnmanaged.e" title="Exception">e</a>.<span title="()String">toString</span><span class="delimiter">)</span>
          <a href="#sbt.TrapExit.runUnmanaged.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.trace(5f37c81d43)" title="(t: =&gt; Throwable)Unit">trace</a><span class="delimiter">(</span><a href="#sbt.TrapExit.runUnmanaged.e" title="Exception">e</a><span class="delimiter">)</span>
          <span title="Int(1)" class="int">1</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">type</span> <a title="String" id="sbt.TrapExit;ThreadID">ThreadID</a> = <span title="String">String</span>

  <span class="comment">/** `true` if the thread `t` is in the TERMINATED state.x*/</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(t: Thread)Boolean" id="sbt.TrapExit.isDone">isDone</a><span class="delimiter">(</span><a title="Thread" id="sbt.TrapExit.isDone.t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#sbt.TrapExit.isDone.t" title="Thread">t</a>.<span title="()java.lang.Thread.State">getState</span> <span title="(x$1: AnyRef)Boolean">==</span> Thread.State.<span title="java.lang.Thread.State(TERMINATED)">TERMINATED</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(g: ThreadGroup)sbt.TrapExit.ThreadID" id="sbt.TrapExit.computeID(9c897c8791)">computeID</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt.TrapExit.computeID(9c897c8791).g">g</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="sbt.TrapExit.ThreadID">ThreadID</span> =
    <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;g:&quot;)">g:$</span><span class="delimiter">{</span><span title="(x$1: Int)String">hex</span><span class="delimiter">(</span><span title="System.type">System</span>.<span title="(x$1: Any)Int">identityHashCode</span><span class="delimiter">(</span><a href="#sbt.TrapExit.computeID(9c897c8791).g" title="ThreadGroup">g</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">}</span><span title="String(&quot;:&quot;)">:$</span><span class="delimiter">{</span><a href="#sbt.TrapExit.computeID(9c897c8791).g" title="ThreadGroup">g</a>.<span title="()String">getName</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span>

  <span class="comment">/** Computes an identifier for a Thread that has a high probability of being unique within a single JVM execution. */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(t: Thread)sbt.TrapExit.ThreadID" id="sbt.TrapExit.computeID(453a482432)">computeID</a><span class="delimiter">(</span><a title="Thread" id="sbt.TrapExit.computeID(453a482432).t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="sbt.TrapExit.ThreadID">ThreadID</span> =
    <span class="comment">// can't use t.getId because when getAccess first sees a Thread, it hasn't been initialized yet</span>
    <span class="comment">// can't use t.getName because calling it on AWT thread in certain circumstances generates a segfault (#997):</span>
    <span class="comment">//    Apple AWT: +[ThreadUtilities getJNIEnvUncached] attempting to attach current thread after JNFObtainEnv() failed</span>
    <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;&quot;)">$</span><span class="delimiter">{</span><span title="(x$1: Int)String">hex</span><span class="delimiter">(</span><span title="System.type">System</span>.<span title="(x$1: Any)Int">identityHashCode</span><span class="delimiter">(</span><a href="#sbt.TrapExit.computeID(453a482432).t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span>

  <span class="comment">/** Waits for the given `thread` to terminate.  However, if the thread state is NEW, this method returns immediately. */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(thread: Thread, log: sbt.Logger)Unit" id="sbt.TrapExit.waitOnThread">waitOnThread</a><span class="delimiter">(</span><a title="Thread" id="sbt.TrapExit.waitOnThread.thread">thread</a>: <span title="Thread">Thread</span>, <a title="sbt.Logger" id="sbt.TrapExit.waitOnThread.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#sbt.TrapExit.waitOnThread.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Waiting for thread &quot;)" class="string">&quot;Waiting for thread &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt.TrapExit.waitOnThread.thread" title="Thread">thread</a>.<span title="()String">getName</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot; to terminate.&quot;)" class="string">&quot; to terminate.&quot;</span><span class="delimiter">)</span>
    <a href="#sbt.TrapExit.waitOnThread.thread" title="Thread">thread</a>.<span title="()Unit">join</span>
    <a href="#sbt.TrapExit.waitOnThread.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;\tThread &quot;)" class="string">&quot;\tThread &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt.TrapExit.waitOnThread.thread" title="Thread">thread</a>.<span title="()String">getName</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot; exited.&quot;)" class="string">&quot; exited.&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// interrupts the given thread, but first replaces the exception handler so that the InterruptedException is not printed</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(thread: Thread, log: sbt.Logger)Unit" id="sbt.TrapExit.safeInterrupt">safeInterrupt</a><span class="delimiter">(</span><a title="Thread" id="sbt.TrapExit.safeInterrupt.thread">thread</a>: <span title="Thread">Thread</span>, <a title="sbt.Logger" id="sbt.TrapExit.safeInterrupt.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="String" id="sbt.TrapExit.safeInterrupt.name">name</a> = <a href="#sbt.TrapExit.safeInterrupt.thread" title="Thread">thread</a>.<span title="()String">getName</span>
    <a href="#sbt.TrapExit.safeInterrupt.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Interrupting thread &quot;)" class="string">&quot;Interrupting thread &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt.TrapExit.safeInterrupt.thread" title="Thread">thread</a>.<span title="()String">getName</span><span class="delimiter">)</span>
    <a href="#sbt.TrapExit.safeInterrupt.thread" title="Thread">thread</a>.<span title="(x$1: java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span><span class="delimiter">(</span><span title="sbt.TrapExit.TrapInterrupt" class="keyword">new</span> <a href="#sbt.TrapExit;TrapInterrupt" title="sbt.TrapExit.TrapInterrupt">TrapInterrupt</a><span class="delimiter">(</span><a href="#sbt.TrapExit.safeInterrupt.thread" title="Thread">thread</a>.<span title="()java.lang.Thread.UncaughtExceptionHandler">getUncaughtExceptionHandler</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#sbt.TrapExit.safeInterrupt.thread" title="Thread">thread</a>.<span title="()Unit">interrupt</span>
    <a href="#sbt.TrapExit.safeInterrupt.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;\tInterrupted &quot;)" class="string">&quot;\tInterrupted &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt.TrapExit.safeInterrupt.thread" title="Thread">thread</a>.<span title="()String">getName</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="comment">// an uncaught exception handler that swallows InterruptedExceptions and otherwise defers to originalHandler</span>
  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapInterrupt extends Object with Thread.UncaughtExceptionHandler" id="sbt.TrapExit;TrapInterrupt">TrapInterrupt</a><a href="#sbt.TrapExit;TrapInterrupt" title="sbt.TrapExit.TrapInterrupt" class="delimiter">(</a><a title="Thread.UncaughtExceptionHandler" id="sbt.TrapExit;TrapInterrupt.originalHandler">originalHandler</a>: Thread.<span title="Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span><span class="delimiter">)</span> <span class="keyword">extends</span> Thread.<span title="Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span> <span class="delimiter">{</span>
    <span class="keyword">def</span> <a title="(thread: Thread, e: Throwable)Unit" id="sbt.TrapExit;TrapInterrupt.uncaughtException">uncaughtException</a><span class="delimiter">(</span><a title="Thread" id="sbt.TrapExit;TrapInterrupt.uncaughtException.thread">thread</a>: <span title="Thread">Thread</span>, <a title="Throwable" id="sbt.TrapExit;TrapInterrupt.uncaughtException.e">e</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#sbt.TrapExit.withCause" title="[CauseType &lt;: Throwable, T](e: Throwable)(withType: CauseType =&gt; T)(notType: Throwable =&gt; T)(implicit mf: scala.reflect.Manifest[CauseType])T">withCause</a><span title="(e: Throwable)(withType: InterruptedException =&gt; Unit)(notType: Throwable =&gt; Unit)(implicit mf: scala.reflect.Manifest[InterruptedException])Unit" class="delimiter">[</span><span title="InterruptedException">InterruptedException</span>, <span title="Unit">Unit</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#sbt.TrapExit;TrapInterrupt.uncaughtException.e" title="Throwable">e</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a title="InterruptedException" id="sbt.TrapExit;TrapInterrupt.uncaughtException.$anonfun.interrupted">interrupted</a> =&gt; <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span title="(clazz: Class[_])scala.reflect.Manifest[InterruptedException]" class="delimiter">{</span> <a title="Throwable" id="sbt.TrapExit;TrapInterrupt.uncaughtException.$anonfun.other">other</a> =&gt; <a href="#sbt.TrapExit;TrapInterrupt.originalHandler" title="Thread.UncaughtExceptionHandler">originalHandler</a>.<span title="(x$1: Thread, x$2: Throwable)Unit">uncaughtException</span><span class="delimiter">(</span><a href="#sbt.TrapExit;TrapInterrupt.uncaughtException.thread" title="Thread">thread</a>, <a href="#sbt.TrapExit;TrapInterrupt.uncaughtException.e" title="Throwable">e</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      <a href="#sbt.TrapExit;TrapInterrupt.uncaughtException.thread" title="Thread">thread</a>.<span title="(x$1: java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span><span class="delimiter">(</span><a href="#sbt.TrapExit;TrapInterrupt.originalHandler" title="Thread.UncaughtExceptionHandler">originalHandler</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="comment">/**
   * Recurses into the causes of the given exception looking for a cause of type CauseType.  If one is found, `withType` is called with that cause.
   *  If not, `notType` is called with the root cause.
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="[CauseType &lt;: Throwable, T](e: Throwable)(withType: CauseType =&gt; T)(notType: Throwable =&gt; T)(implicit mf: scala.reflect.Manifest[CauseType])T" id="sbt.TrapExit.withCause">withCause</a><span class="delimiter">[</span><a title=" &lt;: Throwable" id="sbt.TrapExit.withCause;CauseType">CauseType</a> &lt;: Throwable, <a title="" id="sbt.TrapExit.withCause;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Throwable" id="sbt.TrapExit.withCause.e">e</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="CauseType =&gt; T" id="sbt.TrapExit.withCause.withType">withType</a>: CauseType =&gt; T<span class="delimiter">)</span><span class="delimiter">(</span><a title="Throwable =&gt; T" id="sbt.TrapExit.withCause.notType">notType</a>: Throwable =&gt; T<span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="scala.reflect.Manifest[CauseType]" id="sbt.TrapExit.withCause.mf">mf</a>: <span title="scala.reflect.Manifest[CauseType]">Manifest</span><span class="delimiter">[</span>CauseType<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#sbt.TrapExit.withCause;T" title="T">T</a> =
    <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Class[_]" id="sbt.TrapExit.withCause.clazz">clazz</a> = <a href="#sbt.TrapExit.withCause.mf" title="scala.reflect.Manifest[CauseType]">mf</a>.<span title="=&gt; Class[_]">runtimeClass</span>
      <span title="T" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.clazz" title="Class[_]">clazz</a>.<span title="(x$1: Any)Boolean">isInstance</span><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.e" title="Throwable">e</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#sbt.TrapExit.withCause.withType" title="(v1: CauseType)T">withType</a><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.e" title="Throwable">e</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="CauseType" class="delimiter">[</span><a href="#sbt.TrapExit.withCause;CauseType" title="CauseType">CauseType</a><span class="delimiter">]</span><span class="delimiter">)</span>
      <span class="keyword">else</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Throwable" id="sbt.TrapExit.withCause.cause">cause</a> = <a href="#sbt.TrapExit.withCause.e" title="Throwable">e</a>.<span title="()Throwable">getCause</span>
        <span title="T" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.cause" title="Throwable">cause</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
          <a href="#sbt.TrapExit.withCause.notType" title="(v1: Throwable)T">notType</a><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.e" title="Throwable">e</a><span class="delimiter">)</span>
        <span class="keyword">else</span>
          <a href="#sbt.TrapExit.withCause" title="(e: Throwable)(withType: CauseType =&gt; T)(notType: Throwable =&gt; T)(implicit mf: scala.reflect.Manifest[CauseType])T">withCause</a><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.cause" title="Throwable">cause</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.withType" title="CauseType =&gt; T">withType</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.notType" title="Throwable =&gt; T">notType</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#sbt.TrapExit.withCause.mf" title="scala.reflect.Manifest[CauseType]">mf</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="comment">/**
 * Simulates isolation via a SecurityManager.
 * Multiple applications are supported by tracking Thread constructions via `checkAccess`.
 * The Thread that constructed each Thread is used to map a new Thread to an application.
 * This is not reliable on all jvms, so ThreadGroup creations are also tracked via
 * `checkAccess` and traversed on demand to collect threads.
 * This association of Threads with an application allows properly waiting for
 * non-daemon threads to terminate or to interrupt the correct threads when terminating.
 * It also allows disposing AWT windows if the application created any.
 * Only one AWT application is supported at a time, however.
 */</span>
<span title="AnyRef" class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class TrapExit extends SecurityManager" id="sbt;TrapExit">TrapExit</a><a href="#sbt;TrapExit" title="sbt.TrapExit" class="delimiter">(</a><a title="SecurityManager" id="sbt;TrapExit.delegateManager">delegateManager</a>: <span title="SecurityManager">SecurityManager</span><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="SecurityManager">SecurityManager</span> <span class="delimiter">{</span>
  <span class="comment">/** Tracks the number of running applications in order to short-cut SecurityManager checks when no applications are active.*/</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicInteger" id="sbt;TrapExit.running">running</a> = <span title="()java.util.concurrent.atomic.AtomicInteger" class="keyword">new</span> java.util.concurrent.atomic.<span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span>

  <span class="comment">/** Maps a thread or thread group to its originating application.  The thread is represented by a unique identifier to avoid leaks. */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]" id="sbt;TrapExit.threadToApp">threadToApp</a> = <span title="()java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]" class="keyword">new</span> <span title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]">CMap</span><span class="delimiter">[</span>ThreadID, App<span class="delimiter">]</span>

  <span class="comment">/** Executes `f` in a managed context. */</span>
  <span class="keyword">def</span> <a title="(f: xsbti.F0[Unit], xlog: xsbti.Logger)Int" id="sbt;TrapExit.runManaged">runManaged</a><span class="delimiter">(</span><a title="xsbti.F0[Unit]" id="sbt;TrapExit.runManaged.f">f</a>: xsbti.<a href="../xsbti/F0.java.html#xsbti;F0" title="xsbti.F0[Unit]">F0</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span>, <a title="xsbti.Logger" id="sbt;TrapExit.runManaged.xlog">xlog</a>: xsbti.<a href="../xsbti/Logger.java.html#xsbti;Logger" title="xsbti.Logger">Logger</a><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Int" id="sbt;TrapExit.runManaged._">_</a> = <a href="#sbt;TrapExit.running" title="java.util.concurrent.atomic.AtomicInteger">running</a>.<span title="()Int">incrementAndGet</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">try</span> <a href="#sbt;TrapExit.runManaged0" title="(f: xsbti.F0[Unit], xlog: xsbti.Logger)Int">runManaged0</a><span class="delimiter">(</span><a href="#sbt;TrapExit.runManaged.f" title="xsbti.F0[Unit]">f</a>, <a href="#sbt;TrapExit.runManaged.xlog" title="xsbti.Logger">xlog</a><span class="delimiter">)</span>
      <span class="keyword">finally</span> <a href="#sbt;TrapExit.running" title="java.util.concurrent.atomic.AtomicInteger">running</a>.<span title="()Int">decrementAndGet</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(f: xsbti.F0[Unit], xlog: xsbti.Logger)Int" id="sbt;TrapExit.runManaged0">runManaged0</a><span class="delimiter">(</span><a title="xsbti.F0[Unit]" id="sbt;TrapExit.runManaged0.f">f</a>: xsbti.<a href="../xsbti/F0.java.html#xsbti;F0" title="xsbti.F0[Unit]">F0</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span>, <a title="xsbti.Logger" id="sbt;TrapExit.runManaged0.xlog">xlog</a>: xsbti.<a href="../xsbti/Logger.java.html#xsbti;Logger" title="xsbti.Logger">Logger</a><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="sbt.Logger" id="sbt;TrapExit.runManaged0.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a> = <a href="Logger.scala.html#sbt.Logger.xlog2Log" title="implicit sbt.Logger.xlog2Log : (lg: xsbti.Logger)sbt.Logger">xlog</a>
      <span class="keyword">val</span> <a title="TrapExit.this.App" id="sbt;TrapExit.runManaged0.app">app</a> = <span title="TrapExit.this.App" class="keyword">new</span> <a href="#sbt;TrapExit;App" title="TrapExit.this.App">App</a><span class="delimiter">(</span><a href="#sbt;TrapExit.runManaged0.f" title="xsbti.F0[Unit]">f</a>, <a href="#sbt;TrapExit.runManaged0.log" title="sbt.Logger">log</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Thread" id="sbt;TrapExit.runManaged0.executionThread">executionThread</a> = <a href="#sbt;TrapExit.runManaged0.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.mainThread" title="=&gt; Thread">mainThread</a>
      <span class="keyword">try</span> <span class="delimiter">{</span>
        <a href="#sbt;TrapExit.runManaged0.executionThread" title="Thread">executionThread</a>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// thread actually evaluating `f`</span>
        <a href="#sbt;TrapExit.finish" title="(app: TrapExit.this.App, log: sbt.Logger)Int">finish</a><span class="delimiter">(</span><a href="#sbt;TrapExit.runManaged0.app" title="TrapExit.this.App">app</a>, <a href="#sbt;TrapExit.runManaged0.log" title="sbt.Logger">log</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="InterruptedException" id="sbt;TrapExit.runManaged0.e">e</a>: <span title="InterruptedException">InterruptedException</span> =&gt; <span class="comment">// here, the thread that started the run has been interrupted, not the main thread of the executing code</span>
          <a href="#sbt;TrapExit.cancel" title="(executionThread: Thread, app: TrapExit.this.App, log: sbt.Logger)Int">cancel</a><span class="delimiter">(</span><a href="#sbt;TrapExit.runManaged0.executionThread" title="Thread">executionThread</a>, <a href="#sbt;TrapExit.runManaged0.app" title="TrapExit.this.App">app</a>, <a href="#sbt;TrapExit.runManaged0.log" title="sbt.Logger">log</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">finally</span> <a href="#sbt;TrapExit.runManaged0.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.cleanup(aa97cb1b3d)" title="()Unit">cleanup</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="comment">/** Interrupt all threads and indicate failure in the exit code. */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(executionThread: Thread, app: TrapExit.this.App, log: sbt.Logger)Int" id="sbt;TrapExit.cancel">cancel</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit.cancel.executionThread">executionThread</a>: <span title="Thread">Thread</span>, <a title="TrapExit.this.App" id="sbt;TrapExit.cancel.app">app</a>: <a href="#sbt;TrapExit;App" title="TrapExit.this.App">App</a>, <a title="sbt.Logger" id="sbt;TrapExit.cancel.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <span class="delimiter">{</span>
      <a href="#sbt;TrapExit.cancel.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.warn(83d3728a3c)" title="(message: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="String(&quot;Run canceled.&quot;)" class="string">&quot;Run canceled.&quot;</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.cancel.executionThread" title="Thread">executionThread</a>.<span title="()Unit">interrupt</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.stopAllThreads" title="(app: TrapExit.this.App)Unit">stopAllThreads</a><span class="delimiter">(</span><a href="#sbt;TrapExit.cancel.app" title="TrapExit.this.App">app</a><span class="delimiter">)</span>
      <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>

  <span class="comment">/**
   * Wait for all non-daemon threads for `app` to exit, for an exception to be thrown in the main thread,
   * or for `System.exit` to be called in a thread started by `app`.
   */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(app: TrapExit.this.App, log: sbt.Logger)Int" id="sbt;TrapExit.finish">finish</a><span class="delimiter">(</span><a title="TrapExit.this.App" id="sbt;TrapExit.finish.app">app</a>: <a href="#sbt;TrapExit;App" title="TrapExit.this.App">App</a>, <a title="sbt.Logger" id="sbt;TrapExit.finish.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Int">Int</span> =
    <span class="delimiter">{</span>
      <a href="#sbt;TrapExit.finish.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Waiting for threads to exit or System.exit to be called.&quot;)" class="string">&quot;Waiting for threads to exit or System.exit to be called.&quot;</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.waitForExit" title="(app: TrapExit.this.App)Unit">waitForExit</a><span class="delimiter">(</span><a href="#sbt;TrapExit.finish.app" title="TrapExit.this.App">app</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.finish.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Interrupting remaining threads (should be all daemons).&quot;)" class="string">&quot;Interrupting remaining threads (should be all daemons).&quot;</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.stopAllThreads" title="(app: TrapExit.this.App)Unit">stopAllThreads</a><span class="delimiter">(</span><a href="#sbt;TrapExit.finish.app" title="TrapExit.this.App">app</a><span class="delimiter">)</span> <span class="comment">// should only be daemon threads left now</span>
      <a href="#sbt;TrapExit.finish.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Sandboxed run complete..&quot;)" class="string">&quot;Sandboxed run complete..&quot;</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.finish.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.exitCode" title="=&gt; sbt.ExitCode">exitCode</a>.<a href="#sbt;ExitCode.value" title="=&gt; Option[Int]">value</a>.<span title="(default: =&gt; Int)Int">getOrElse</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">// wait for all non-daemon threads to terminate</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(app: TrapExit.this.App)Unit" id="sbt;TrapExit.waitForExit">waitForExit</a><span class="delimiter">(</span><a title="TrapExit.this.App" id="sbt;TrapExit.waitForExit.app">app</a>: <a href="#sbt;TrapExit;App" title="TrapExit.this.App">App</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Boolean" id="sbt;TrapExit.waitForExit.daemonsOnly">daemonsOnly</a> = <span title="Boolean(true)" class="keyword">true</span>
    <a href="#sbt;TrapExit.waitForExit.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.processThreads" title="(f: Thread =&gt; Unit)Unit">processThreads</a> <span class="delimiter">{</span> <a title="Thread" id="sbt;TrapExit.waitForExit.$anonfun.thread">thread</a> =&gt;
      <span class="comment">// check isAlive because calling `join` on a thread that hasn't started returns immediately</span>
      <span class="comment">//  and App will only remove threads that have terminated, which will make this method loop continuously</span>
      <span class="comment">//  if a thread is created but not started</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.waitForExit.$anonfun.thread" title="Thread">thread</a>.<span title="()Boolean">isAlive</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit.waitForExit.$anonfun.thread" title="Thread">thread</a>.<span title="()Boolean">isDaemon</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#sbt;TrapExit.waitForExit.daemonsOnly" title="Boolean">daemonsOnly</a> = <span title="Boolean(false)" class="keyword">false</span>
        <a href="#sbt.TrapExit.waitOnThread" title="(thread: Thread, log: sbt.Logger)Unit">waitOnThread</a><span class="delimiter">(</span><a href="#sbt;TrapExit.waitForExit.$anonfun.thread" title="Thread">thread</a>, <a href="#sbt;TrapExit.waitForExit.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.log" title="=&gt; sbt.Logger">log</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span class="comment">// processThreads takes a snapshot of the threads at a given moment, so if there were only daemons, the application should shut down</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit.waitForExit.daemonsOnly" title="Boolean">daemonsOnly</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.waitForExit" title="(app: TrapExit.this.App)Unit">waitForExit</a><span class="delimiter">(</span><a href="#sbt;TrapExit.waitForExit.app" title="TrapExit.this.App">app</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Gives managed applications a unique ID to use in the IDs of the main thread and thread group. */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="java.util.concurrent.atomic.AtomicLong" id="sbt;TrapExit.nextAppID">nextAppID</a> = <span title="()java.util.concurrent.atomic.AtomicLong" class="keyword">new</span> java.util.concurrent.atomic.<span title="java.util.concurrent.atomic.AtomicLong">AtomicLong</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()String" id="sbt;TrapExit.nextID">nextID</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#sbt;TrapExit.nextAppID" title="java.util.concurrent.atomic.AtomicLong">nextAppID</a>.<span title="implicit scala.LowPriorityImplicits.longWrapper : (x: Long)scala.runtime.RichLong">getAndIncrement</span>.<span title="=&gt; String">toHexString</span>

  <span class="comment">/**
   * Represents an isolated application as simulated by [[TrapExit]].
   * `execute` is the application code to evalute.
   * `log` is used for debug logging.
   */</span>
  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class App extends Object with Runnable" id="sbt;TrapExit;App">App</a><a href="#sbt;TrapExit;App" title="TrapExit.this.App" class="delimiter">(</a><span class="keyword">val</span> <a title="xsbti.F0[Unit]" id="sbt;TrapExit;App.execute">execute</a>: xsbti.<a href="../xsbti/F0.java.html#xsbti;F0" title="xsbti.F0[Unit]">F0</a><span class="delimiter">[</span>Unit<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="sbt.Logger" id="sbt;TrapExit;App.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span> <span class="keyword">extends</span> <span title="Runnable">Runnable</span> <span class="delimiter">{</span>
    <span class="comment">/**
     * Tracks threads and groups created by this application.
     * To avoid leaks, keys are a unique identifier and values are held via WeakReference.
     * A TrieMap supports the necessary concurrent updates and snapshots.
     */</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]" id="sbt;TrapExit;App.threads">threads</a> = <span title="()scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]" class="keyword">new</span> <span title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]">TrieMap</span><span class="delimiter">[</span>ThreadID, WeakReference<span class="delimiter">[</span>Thread<span class="delimiter">]</span><span class="delimiter">]</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]" id="sbt;TrapExit;App.groups">groups</a> = <span title="()scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]" class="keyword">new</span> <span title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]">TrieMap</span><span class="delimiter">[</span>ThreadID, WeakReference<span class="delimiter">[</span>ThreadGroup<span class="delimiter">]</span><span class="delimiter">]</span>

    <span class="comment">/** Tracks whether AWT has ever been used in this jvm execution. */</span>
    @volatile
    <span class="keyword">var</span> <a title="Boolean" id="sbt;TrapExit;App.awtUsed_=">awtUsed</a> = <span title="Boolean(false)" class="keyword">false</span>

    <span class="comment">/** The unique ID of the application. */</span>
    <span class="keyword">val</span> <a title="String" id="sbt;TrapExit;App.id">id</a> = <a href="#sbt;TrapExit.nextID" title="()String">nextID</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">/** The ThreadGroup to use to try to track created threads. */</span>
    <span class="keyword">val</span> <a title="ThreadGroup" id="sbt;TrapExit;App.mainGroup">mainGroup</a>: <span title="ThreadGroup">ThreadGroup</span> = <a href="#sbt;TrapExit;App.mainGroup;$anon" title="ThreadGroup{}" class="keyword">new</a> <a title="anonymous class $anon extends ThreadGroup" id="sbt;TrapExit;App.mainGroup;$anon">ThreadGroup</a><span class="delimiter">(</span><span title="String(&quot;run-main-group-&quot;)" class="string">&quot;run-main-group-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt;TrapExit;App.id" title="=&gt; String">id</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="sbt.LoggingExceptionHandler" id="sbt;TrapExit;App.mainGroup;$anon.handler">handler</a> = <span title="sbt.LoggingExceptionHandler" class="keyword">new</span> <a href="#sbt;LoggingExceptionHandler" title="sbt.LoggingExceptionHandler">LoggingExceptionHandler</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.log" title="=&gt; sbt.Logger">log</a>, <span title="None.type">None</span><span class="delimiter">)</span>
      <span class="keyword">override</span> <span class="keyword">def</span> <a title="(t: Thread, e: Throwable)Unit" id="sbt;TrapExit;App.mainGroup;$anon.uncaughtException">uncaughtException</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit;App.mainGroup;$anon.uncaughtException.t">t</a>: <span title="Thread">Thread</span>, <a title="Throwable" id="sbt;TrapExit;App.mainGroup;$anon.uncaughtException.e">e</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#sbt;TrapExit;App.mainGroup;$anon.handler" title="sbt.LoggingExceptionHandler">handler</a>.<a href="#sbt;LoggingExceptionHandler.uncaughtException" title="(t: Thread, e: Throwable)Unit">uncaughtException</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.mainGroup;$anon.uncaughtException.t" title="Thread">t</a>, <a href="#sbt;TrapExit;App.mainGroup;$anon.uncaughtException.e" title="Throwable">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="Thread" id="sbt;TrapExit;App.mainThread">mainThread</a> = <span title="(x$1: ThreadGroup, x$2: Runnable, x$3: String)Thread" class="keyword">new</span> <span title="Thread">Thread</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.mainGroup" title="=&gt; ThreadGroup">mainGroup</a>, <a href="#sbt;TrapExit;App" title="TrapExit.this.App" class="keyword">this</a>, <span title="String(&quot;run-main-&quot;)" class="string">&quot;run-main-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt;TrapExit;App.id" title="=&gt; String">id</a><span class="delimiter">)</span>

    <span class="comment">/** Saves the ids of the creating thread and thread group to avoid tracking them as coming from this application. */</span>
    <span class="keyword">val</span> <a title="sbt.TrapExit.ThreadID" id="sbt;TrapExit;App.creatorThreadID">creatorThreadID</a> = <a href="#sbt.TrapExit.computeID(453a482432)" title="(t: Thread)sbt.TrapExit.ThreadID">computeID</a><span class="delimiter">(</span><span title="()Thread">currentThread</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="ThreadGroup" id="sbt;TrapExit;App.creatorGroup">creatorGroup</a> = <span title="()Thread">currentThread</span>.<span title="()ThreadGroup">getThreadGroup</span>

    <a href="#sbt;TrapExit;App.register(92ff781945)" title="(t: Thread)Unit">register</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.mainThread" title="=&gt; Thread">mainThread</a><span class="delimiter">)</span>
    <a href="#sbt;TrapExit;App.register(aee7b3b88a)" title="(g: ThreadGroup)Unit">register</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.mainGroup" title="=&gt; ThreadGroup">mainGroup</a><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="sbt.ExitCode" id="sbt;TrapExit;App.exitCode">exitCode</a> = <span title="sbt.ExitCode" class="keyword">new</span> <a href="#sbt;ExitCode" title="sbt.ExitCode">ExitCode</a>

    <span class="keyword">def</span> <a title="()Unit" id="sbt;TrapExit;App.run">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">try</span> <a href="../xsbti/F0.java.html#xsbti;F0.apply" title="()Unit">execute</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">catch</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="Throwable" id="sbt;TrapExit;App.run.x">x</a>: <span title="Throwable">Throwable</span> =&gt;
          <a href="#sbt;TrapExit;App.exitCode" title="=&gt; sbt.ExitCode">exitCode</a>.<a href="#sbt;ExitCode.set" title="(c: Int)Unit">set</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="comment">//exceptions in the main thread cause the exit code to be 1</span>
          <span title="Nothing" class="keyword">throw</span> <a href="#sbt;TrapExit;App.run.x" title="Throwable">x</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/** Records a new group both in the global [[TrapExit]] manager and for this [[App]].*/</span>
    <span class="keyword">def</span> <a title="(g: ThreadGroup)Unit" id="sbt;TrapExit;App.register(aee7b3b88a)">register</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit;App.register(aee7b3b88a).g">g</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).g" title="ThreadGroup">g</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#sbt;TrapExit;App.register(aee7b3b88a).g" title="ThreadGroup">g</a> <span title="(x$1: AnyRef)Boolean">!=</span> <a href="#sbt;TrapExit;App.creatorGroup" title="=&gt; ThreadGroup">creatorGroup</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit.isSystemGroup" title="(group: ThreadGroup)Boolean">isSystemGroup</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).g" title="ThreadGroup">g</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="sbt.TrapExit.ThreadID" id="sbt;TrapExit;App.register(aee7b3b88a).groupID">groupID</a> = <a href="#sbt.TrapExit.computeID(9c897c8791)" title="(g: ThreadGroup)sbt.TrapExit.ThreadID">computeID</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).g" title="ThreadGroup">g</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Option[java.lang.ref.WeakReference[ThreadGroup]]" id="sbt;TrapExit;App.register(aee7b3b88a).old">old</a> = <a href="#sbt;TrapExit;App.groups" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]">groups</a>.<span title="(k: sbt.TrapExit.ThreadID, v: java.lang.ref.WeakReference[ThreadGroup])Option[java.lang.ref.WeakReference[ThreadGroup]]">putIfAbsent</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).groupID" title="sbt.TrapExit.ThreadID">groupID</a>, <span title="java.lang.ref.WeakReference[ThreadGroup]" class="keyword">new</span> <span title="java.lang.ref.WeakReference[ThreadGroup]">WeakReference</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).g" title="ThreadGroup">g</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).old" title="Option[java.lang.ref.WeakReference[ThreadGroup]]">old</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// wasn't registered</span>
          <a href="#sbt;TrapExit.threadToApp" title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]">threadToApp</a>.<span title="(x$1: sbt.TrapExit.ThreadID, x$2: TrapExit.this.App)TrapExit.this.App">put</span><span title="Unit" class="delimiter">(</span><a href="#sbt;TrapExit;App.register(aee7b3b88a).groupID" title="sbt.TrapExit.ThreadID">groupID</a>, <a href="#sbt;TrapExit;App" title="TrapExit.this.App" class="keyword">this</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

    <span class="comment">/**
     * Records a new thread both in the global [[TrapExit]] manager and for this [[App]].
     * Its uncaught exception handler is configured to log exceptions through `log`.
     */</span>
    <span class="keyword">def</span> <a title="(t: Thread)Unit" id="sbt;TrapExit;App.register(92ff781945)">register</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit;App.register(92ff781945).t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="sbt.TrapExit.ThreadID" id="sbt;TrapExit;App.register(92ff781945).threadID">threadID</a> = <a href="#sbt.TrapExit.computeID(453a482432)" title="(t: Thread)sbt.TrapExit.ThreadID">computeID</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#sbt.TrapExit.isDone" title="(t: Thread)Boolean">isDone</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#sbt;TrapExit;App.register(92ff781945).threadID" title="sbt.TrapExit.ThreadID">threadID</a> <span title="(x$1: AnyRef)Boolean">!=</span> <a href="#sbt;TrapExit;App.creatorThreadID" title="=&gt; sbt.TrapExit.ThreadID">creatorThreadID</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="Option[java.lang.ref.WeakReference[Thread]]" id="sbt;TrapExit;App.register(92ff781945).old">old</a> = <a href="#sbt;TrapExit;App.threads" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]">threads</a>.<span title="(k: sbt.TrapExit.ThreadID, v: java.lang.ref.WeakReference[Thread])Option[java.lang.ref.WeakReference[Thread]]">putIfAbsent</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).threadID" title="sbt.TrapExit.ThreadID">threadID</a>, <span title="java.lang.ref.WeakReference[Thread]" class="keyword">new</span> <span title="java.lang.ref.WeakReference[Thread]">WeakReference</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).old" title="Option[java.lang.ref.WeakReference[Thread]]">old</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// wasn't registered</span>
            <a href="#sbt;TrapExit.threadToApp" title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]">threadToApp</a>.<span title="(x$1: sbt.TrapExit.ThreadID, x$2: TrapExit.this.App)TrapExit.this.App">put</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).threadID" title="sbt.TrapExit.ThreadID">threadID</a>, <a href="#sbt;TrapExit;App" title="TrapExit.this.App" class="keyword">this</a><span class="delimiter">)</span>
            <a href="#sbt;TrapExit;App.setExceptionHandler" title="(t: Thread)Unit">setExceptionHandler</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span>
            <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit;App.awtUsed_=" title="=&gt; Boolean">awtUsed</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#sbt;TrapExit.isEventQueue" title="(t: Thread)Boolean">isEventQueue</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.register(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#sbt;TrapExit;App.awtUsed_=" title="(x$1: Boolean)Unit">awtUsed</a> = <span title="Boolean(true)" class="keyword">true</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

    <span class="comment">/** Registers the logging exception handler on `t`, delegating to the existing handler if it isn't the default. */</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(t: Thread)Unit" id="sbt;TrapExit;App.setExceptionHandler">setExceptionHandler</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit;App.setExceptionHandler.t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="ThreadGroup" id="sbt;TrapExit;App.setExceptionHandler.group">group</a> = <a href="#sbt;TrapExit;App.setExceptionHandler.t" title="Thread">t</a>.<span title="()ThreadGroup">getThreadGroup</span>
      <span class="keyword">val</span> <a title="Option[java.lang.Thread.UncaughtExceptionHandler]" id="sbt;TrapExit;App.setExceptionHandler.previousHandler">previousHandler</a> = <a href="#sbt;TrapExit;App.setExceptionHandler.t" title="Thread">t</a>.<span title="()java.lang.Thread.UncaughtExceptionHandler">getUncaughtExceptionHandler</span> <span title="Option[java.lang.Thread.UncaughtExceptionHandler]" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <span title="Null(null)" class="keyword">null</span> | <a href="#sbt;TrapExit;App.setExceptionHandler.group" title="ThreadGroup">`group`</a> | <span class="delimiter">(</span>_: <a href="#sbt;LoggingExceptionHandler" title="sbt.LoggingExceptionHandler">LoggingExceptionHandler</a><span class="delimiter">)</span> =&gt; <span title="None.type">None</span>
        <span class="keyword">case</span> <a title="java.lang.Thread.UncaughtExceptionHandler" id="sbt;TrapExit;App.setExceptionHandler.previousHandler.x">x</a> =&gt; <span title="(x: java.lang.Thread.UncaughtExceptionHandler)Some[java.lang.Thread.UncaughtExceptionHandler]">Some</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.setExceptionHandler.previousHandler.x" title="java.lang.Thread.UncaughtExceptionHandler">x</a><span class="delimiter">)</span> <span class="comment">// delegate to a custom handler only</span>
      <span class="delimiter">}</span>
      <a href="#sbt;TrapExit;App.setExceptionHandler.t" title="Thread">t</a>.<span title="(x$1: java.lang.Thread.UncaughtExceptionHandler)Unit">setUncaughtExceptionHandler</span><span class="delimiter">(</span><span title="sbt.LoggingExceptionHandler" class="keyword">new</span> <a href="#sbt;LoggingExceptionHandler" title="sbt.LoggingExceptionHandler">LoggingExceptionHandler</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.log" title="=&gt; sbt.Logger">log</a>, <a href="#sbt;TrapExit;App.setExceptionHandler.previousHandler" title="Option[java.lang.Thread.UncaughtExceptionHandler]">previousHandler</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/** Removes a thread or group from this [[App]] and the global [[TrapExit]] manager. */</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(id: sbt.TrapExit.ThreadID)Unit" id="sbt;TrapExit;App.unregister">unregister</a><span class="delimiter">(</span><a title="sbt.TrapExit.ThreadID" id="sbt;TrapExit;App.unregister.id">id</a>: <span title="sbt.TrapExit.ThreadID">ThreadID</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#sbt;TrapExit.threadToApp" title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]">threadToApp</a>.<span title="(x$1: Any)TrapExit.this.App">remove</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.unregister.id" title="sbt.TrapExit.ThreadID">id</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit;App.threads" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]">threads</a>.<span title="(k: sbt.TrapExit.ThreadID)Option[java.lang.ref.WeakReference[Thread]]">remove</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.unregister.id" title="sbt.TrapExit.ThreadID">id</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit;App.groups" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]">groups</a>.<span title="(k: sbt.TrapExit.ThreadID)Option[java.lang.ref.WeakReference[ThreadGroup]]">remove</span><span title="Unit" class="delimiter">(</span><a href="#sbt;TrapExit;App.unregister.id" title="sbt.TrapExit.ThreadID">id</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="comment">/** Final cleanup for this application after it has terminated. */</span>
    <span class="keyword">def</span> <a title="()Unit" id="sbt;TrapExit;App.cleanup(aa97cb1b3d)">cleanup</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#sbt;TrapExit;App.cleanup(33319e65e1)" title="(resources: scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _])Unit">cleanup</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threads" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]">threads</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit;App.cleanup(33319e65e1)" title="(resources: scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _])Unit">cleanup</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.groups" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]">groups</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(resources: scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _])Unit" id="sbt;TrapExit;App.cleanup(33319e65e1)">cleanup</a><span class="delimiter">(</span><a title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _]" id="sbt;TrapExit;App.cleanup(33319e65e1).resources">resources</a>: <span title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _]">TrieMap</span><span class="delimiter">[</span>ThreadID, _<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="scala.collection.Map[String,Any]" id="sbt;TrapExit;App.cleanup(33319e65e1).snap">snap</a> = <a href="#sbt;TrapExit;App.cleanup(33319e65e1).resources" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _]">resources</a>.<span title="()scala.collection.Map[sbt.TrapExit.ThreadID,_$1]">readOnlySnapshot</span>
      <a href="#sbt;TrapExit;App.cleanup(33319e65e1).resources" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID, _]">resources</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="sbt;TrapExit;App.cleanup(33319e65e1).$anonfun.id">id</a>, _<span class="delimiter">)</span> &lt;- <a href="#sbt;TrapExit;App.cleanup(33319e65e1).snap" title="(f: ((String, Any)) =&gt; Unit)Unit">snap</a><span class="delimiter">)</span>
        <a href="#sbt;TrapExit;App.unregister" title="(id: sbt.TrapExit.ThreadID)Unit">unregister</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.cleanup(33319e65e1).$anonfun.id" title="String">id</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">// only want to operate on unterminated threads</span>
    <span class="comment">// want to drop terminated threads, including those that have been gc'd</span>
    <span class="comment">/** Evaluates `f` on each `Thread` started by this [[App]] at single instant shortly after this method is called. */</span>
    <span class="keyword">def</span> <a title="(f: Thread =&gt; Unit)Unit" id="sbt;TrapExit;App.processThreads">processThreads</a><span class="delimiter">(</span><a title="Thread =&gt; Unit" id="sbt;TrapExit;App.processThreads.f">f</a>: Thread =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <span class="comment">// pulls in threads that weren't recorded by checkAccess(Thread) (which is jvm-dependent)</span>
      <span class="comment">//  but can be reached via the Threads in the ThreadGroups recorded by checkAccess(ThreadGroup) (not jvm-dependent)</span>
      <a href="#sbt;TrapExit;App.addUntrackedThreads" title="()Unit">addUntrackedThreads</a><span class="delimiter">(</span><span class="delimiter">)</span>

      <span class="keyword">val</span> <a title="scala.collection.Map[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]" id="sbt;TrapExit;App.processThreads.snap">snap</a> = <a href="#sbt;TrapExit;App.threads" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]">threads</a>.<span title="()scala.collection.Map[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[Thread]]">readOnlySnapshot</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="sbt.TrapExit.ThreadID" id="sbt;TrapExit;App.processThreads.$anonfun.id">id</a>, <a title="java.lang.ref.WeakReference[Thread]" id="sbt;TrapExit;App.processThreads.$anonfun.tref">tref</a><span class="delimiter">)</span> &lt;- <a href="#sbt;TrapExit;App.processThreads.snap" title="(f: ((sbt.TrapExit.ThreadID, java.lang.ref.WeakReference[Thread])) =&gt; Unit)Unit">snap</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Thread" id="sbt;TrapExit;App.processThreads.$anonfun.t">t</a> = <a href="#sbt;TrapExit;App.processThreads.$anonfun.tref" title="java.lang.ref.WeakReference[Thread]">tref</a>.<span title="()Thread">get</span>
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.processThreads.$anonfun.t" title="Thread">t</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <a href="#sbt.TrapExit.isDone" title="(t: Thread)Boolean">isDone</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.processThreads.$anonfun.t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#sbt;TrapExit;App.unregister" title="(id: sbt.TrapExit.ThreadID)Unit">unregister</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.processThreads.$anonfun.id" title="sbt.TrapExit.ThreadID">id</a><span class="delimiter">)</span>
        <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#sbt;TrapExit;App.processThreads.f" title="(v1: Thread)Unit">f</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.processThreads.$anonfun.t" title="Thread">t</a><span class="delimiter">)</span>
          <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt.TrapExit.isDone" title="(t: Thread)Boolean">isDone</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.processThreads.$anonfun.t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#sbt;TrapExit;App.unregister" title="(id: sbt.TrapExit.ThreadID)Unit">unregister</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.processThreads.$anonfun.id" title="sbt.TrapExit.ThreadID">id</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">// registers Threads from the tracked ThreadGroups</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="()Unit" id="sbt;TrapExit;App.addUntrackedThreads">addUntrackedThreads</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <a href="#sbt;TrapExit;App.groupThreadsSnapshot" title="=&gt; Seq[Thread]">groupThreadsSnapshot</a> <span title="(f: Thread =&gt; Unit)Unit">foreach</span> <a href="#sbt;TrapExit;App.register(92ff781945)" title="(t: Thread)Unit">register</a>

    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="=&gt; Seq[Thread]" id="sbt;TrapExit;App.groupThreadsSnapshot">groupThreadsSnapshot</a>: <span title="Seq[Thread]">Seq</span><span class="delimiter">[</span>Thread<span class="delimiter">]</span> =
      <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Iterable[ThreadGroup]" id="sbt;TrapExit;App.groupThreadsSnapshot.snap">snap</a> = <a href="#sbt;TrapExit;App.groups" title="scala.collection.concurrent.TrieMap[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]">groups</a>.<span title="()scala.collection.Map[sbt.TrapExit.ThreadID,java.lang.ref.WeakReference[ThreadGroup]]">readOnlySnapshot</span>.<span title="=&gt; Iterable[java.lang.ref.WeakReference[ThreadGroup]]">values</span>.<span title="(f: java.lang.ref.WeakReference[ThreadGroup] =&gt; ThreadGroup)(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[java.lang.ref.WeakReference[ThreadGroup]],ThreadGroup,Iterable[ThreadGroup]])Iterable[ThreadGroup]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Iterable.Coll,ThreadGroup,Iterable[ThreadGroup]]" class="delimiter">(</span><a href="#sbt;TrapExit;App.groupThreadsSnapshot.snap.$anonfun.x$3" title="java.lang.ref.WeakReference[ThreadGroup]">_</a>.<span title="()ThreadGroup">get</span><span class="delimiter">)</span>.<span title="(p: ThreadGroup =&gt; Boolean)Iterable[ThreadGroup]">filter</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.groupThreadsSnapshot.snap.$anonfun.x$4" title="ThreadGroup">_</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
        <a href="#sbt;TrapExit;App.threadsInGroups" title="(toProcess: List[ThreadGroup], accum: List[ThreadGroup])List[Thread]">threadsInGroups</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.groupThreadsSnapshot.snap" title="Iterable[ThreadGroup]">snap</a>.<span title="=&gt; List[ThreadGroup]">toList</span>, <span title="scala.collection.immutable.Nil.type">Nil</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>

    <span class="comment">// takes a snapshot of the threads in `toProcess`, acquiring nested locks on each group to do so</span>
    <span class="comment">// the thread groups are accumulated in `accum` and then the threads in each are collected all at</span>
    <span class="comment">// once while they are all locked.  This is the closest thing to a snapshot that can be accomplished.</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(toProcess: List[ThreadGroup], accum: List[ThreadGroup])List[Thread]" id="sbt;TrapExit;App.threadsInGroups">threadsInGroups</a><span class="delimiter">(</span><a title="List[ThreadGroup]" id="sbt;TrapExit;App.threadsInGroups.toProcess">toProcess</a>: <span title="List[ThreadGroup]">List</span><span class="delimiter">[</span>ThreadGroup<span class="delimiter">]</span>, <a title="List[ThreadGroup]" id="sbt;TrapExit;App.threadsInGroups.accum">accum</a>: <span title="List[ThreadGroup]">List</span><span class="delimiter">[</span>ThreadGroup<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="List[Thread]">List</span><span class="delimiter">[</span>Thread<span class="delimiter">]</span> = <a href="#sbt;TrapExit;App.threadsInGroups.toProcess" title="List[ThreadGroup]">toProcess</a> <span title="List[Thread]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a title="ThreadGroup" id="sbt;TrapExit;App.threadsInGroups.group">group</a> :: <a title="List[ThreadGroup]" id="sbt;TrapExit;App.threadsInGroups.tail">tail</a> =&gt;
        <span class="comment">// ThreadGroup implementation synchronizes on its methods, so by synchronizing here, we can workaround its quirks somewhat</span>
        <a href="#sbt;TrapExit;App.threadsInGroups.group" title="ThreadGroup">group</a>.<span title="(x$1: List[Thread])List[Thread]">synchronized</span> <span class="delimiter">{</span>
          <span class="comment">// not tail recursive because of synchronized</span>
          <a href="#sbt;TrapExit;App.threadsInGroups" title="(toProcess: List[ThreadGroup], accum: List[ThreadGroup])List[Thread]">threadsInGroups</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threadGroups" title="(group: ThreadGroup)List[ThreadGroup]">threadGroups</a><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threadsInGroups.group" title="ThreadGroup">group</a><span class="delimiter">)</span> <a href="#sbt;TrapExit;App.threadsInGroups.x$5" title="(prefix: List[ThreadGroup])List[ThreadGroup]">:::</a> <a href="#sbt;TrapExit;App.threadsInGroups.tail" title="List[ThreadGroup]">tail</a>, <a href="#sbt;TrapExit;App.threadsInGroups.group" title="ThreadGroup">group</a> <a href="#sbt;TrapExit;App.threadsInGroups.x$6" title="(x: ThreadGroup)List[ThreadGroup]">::</a> <a href="#sbt;TrapExit;App.threadsInGroups.accum" title="List[ThreadGroup]">accum</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> <span title="scala.collection.immutable.Nil.type">Nil</span> =&gt; <a href="#sbt;TrapExit;App.threadsInGroups.accum" title="List[ThreadGroup]">accum</a>.<span title="(f: ThreadGroup =&gt; scala.collection.GenTraversableOnce[Thread])(implicit bf: scala.collection.generic.CanBuildFrom[List[ThreadGroup],Thread,List[Thread]])List[Thread]">flatMap</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,Thread,List[Thread]]" class="delimiter">(</span><a href="#sbt;TrapExit;App.threads(75c8abbb50)" title="(group: ThreadGroup)List[Thread]">threads</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">// gets the immediate child ThreadGroups of `group`</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(group: ThreadGroup)List[ThreadGroup]" id="sbt;TrapExit;App.threadGroups">threadGroups</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit;App.threadGroups.group">group</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="List[ThreadGroup]">List</span><span class="delimiter">[</span>ThreadGroup<span class="delimiter">]</span> =
      <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Int" id="sbt;TrapExit;App.threadGroups.upperBound">upperBound</a> = <a href="#sbt;TrapExit;App.threadGroups.group" title="ThreadGroup">group</a>.<span title="()Int">activeGroupCount</span>
        <span class="keyword">val</span> <a title="Array[ThreadGroup]" id="sbt;TrapExit;App.threadGroups.groups">groups</a> = <span title="Array[ThreadGroup]" class="keyword">new</span> <span title="Array[ThreadGroup]">Array</span><span class="delimiter">[</span>ThreadGroup<span class="delimiter">]</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threadGroups.upperBound" title="Int">upperBound</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Int" id="sbt;TrapExit;App.threadGroups.childrenCount">childrenCount</a> = <a href="#sbt;TrapExit;App.threadGroups.group" title="ThreadGroup">group</a>.<span title="(x$1: Array[ThreadGroup], x$2: Boolean)Int">enumerate</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threadGroups.groups" title="Array[ThreadGroup]">groups</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
        <a href="#sbt;TrapExit;App.threadGroups.groups" title="(xs: Array[ThreadGroup])scala.collection.mutable.ArrayOps[ThreadGroup]">groups</a>.<span title="(n: Int)Array[ThreadGroup]">take</span><span title="(xs: Array[ThreadGroup])scala.collection.mutable.ArrayOps[ThreadGroup]" class="delimiter">(</span><a href="#sbt;TrapExit;App.threadGroups.childrenCount" title="Int">childrenCount</a><span class="delimiter">)</span>.<span title="=&gt; List[ThreadGroup]">toList</span>
      <span class="delimiter">}</span>

    <span class="comment">// gets the immediate child Threads of `group`</span>
    <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(group: ThreadGroup)List[Thread]" id="sbt;TrapExit;App.threads(75c8abbb50)">threads</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit;App.threads(75c8abbb50).group">group</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="List[Thread]">List</span><span class="delimiter">[</span>Thread<span class="delimiter">]</span> =
      <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="Int" id="sbt;TrapExit;App.threads(75c8abbb50).upperBound">upperBound</a> = <a href="#sbt;TrapExit;App.threads(75c8abbb50).group" title="ThreadGroup">group</a>.<span title="()Int">activeCount</span>
        <span class="keyword">val</span> <a title="Array[Thread]" id="sbt;TrapExit;App.threads(75c8abbb50).threads">threads</a> = <span title="Array[Thread]" class="keyword">new</span> <span title="Array[Thread]">Array</span><span class="delimiter">[</span>Thread<span class="delimiter">]</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threads(75c8abbb50).upperBound" title="Int">upperBound</a><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="Int" id="sbt;TrapExit;App.threads(75c8abbb50).childrenCount">childrenCount</a> = <a href="#sbt;TrapExit;App.threads(75c8abbb50).group" title="ThreadGroup">group</a>.<span title="(x$1: Array[Thread], x$2: Boolean)Int">enumerate</span><span class="delimiter">(</span><a href="#sbt;TrapExit;App.threads(75c8abbb50).threads" title="Array[Thread]">threads</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
        <a href="#sbt;TrapExit;App.threads(75c8abbb50).threads" title="(xs: Array[Thread])scala.collection.mutable.ArrayOps[Thread]">threads</a>.<span title="(n: Int)Array[Thread]">take</span><span title="(xs: Array[Thread])scala.collection.mutable.ArrayOps[Thread]" class="delimiter">(</span><a href="#sbt;TrapExit;App.threads(75c8abbb50).childrenCount" title="Int">childrenCount</a><span class="delimiter">)</span>.<span title="=&gt; List[Thread]">toList</span>
      <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(app: TrapExit.this.App)Unit" id="sbt;TrapExit.stopAllThreads">stopAllThreads</a><span class="delimiter">(</span><a title="TrapExit.this.App" id="sbt;TrapExit.stopAllThreads.app">app</a>: <a href="#sbt;TrapExit;App" title="TrapExit.this.App">App</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">// only try to dispose frames if we think the App used AWT</span>
    <span class="comment">// otherwise, we initialize AWT as a side effect of asking for the frames</span>
    <span class="comment">// also, we only assume one AWT application at a time</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.stopAllThreads.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.awtUsed_=" title="=&gt; Boolean">awtUsed</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.disposeAllFrames" title="(log: sbt.Logger)Unit">disposeAllFrames</a><span class="delimiter">(</span><a href="#sbt;TrapExit.stopAllThreads.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.log" title="=&gt; sbt.Logger">log</a><span class="delimiter">)</span>
    <a href="#sbt;TrapExit.interruptAllThreads" title="(app: TrapExit.this.App)Unit">interruptAllThreads</a><span class="delimiter">(</span><a href="#sbt;TrapExit.stopAllThreads.app" title="TrapExit.this.App">app</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(app: TrapExit.this.App)Unit" id="sbt;TrapExit.interruptAllThreads">interruptAllThreads</a><span class="delimiter">(</span><a title="TrapExit.this.App" id="sbt;TrapExit.interruptAllThreads.app">app</a>: <a href="#sbt;TrapExit;App" title="TrapExit.this.App">App</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#sbt;TrapExit.interruptAllThreads.app" title="TrapExit.this.App">app</a> <a href="#sbt;TrapExit;App.processThreads" title="(f: Thread =&gt; Unit)Unit">processThreads</a> <span class="delimiter">{</span> <a title="Thread" id="sbt;TrapExit.interruptAllThreads.$anonfun.t">t</a> =&gt; <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit.isSystemThread" title="(t: Thread)Boolean">isSystemThread</a><span class="delimiter">(</span><a href="#sbt;TrapExit.interruptAllThreads.$anonfun.t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#sbt.TrapExit.safeInterrupt" title="(thread: Thread, log: sbt.Logger)Unit">safeInterrupt</a><span class="delimiter">(</span><a href="#sbt;TrapExit.interruptAllThreads.$anonfun.t" title="Thread">t</a>, <a href="#sbt;TrapExit.interruptAllThreads.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.log" title="=&gt; sbt.Logger">log</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="#sbt;TrapExit.interruptAllThreads.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.log" title="=&gt; sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Not interrupting system thread &quot;)">Not interrupting system thread $</span><a href="#sbt;TrapExit.interruptAllThreads.$anonfun.t" title="Thread">t</a><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="comment">/** Gets the managed application associated with Thread `t` */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(t: Thread)Option[TrapExit.this.App]" id="sbt;TrapExit.getApp(cee478b19f)">getApp</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit.getApp(cee478b19f).t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="Option[TrapExit.this.App]">Option</span><span class="delimiter">[</span>App<span class="delimiter">]</span> =
    <span title="(x: TrapExit.this.App)Option[TrapExit.this.App]">Option</span><span class="delimiter">(</span><a href="#sbt;TrapExit.threadToApp" title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]">threadToApp</a>.<span title="(x$1: Any)TrapExit.this.App">get</span><span class="delimiter">(</span><a href="#sbt.TrapExit.computeID(453a482432)" title="(t: Thread)sbt.TrapExit.ThreadID">computeID</a><span class="delimiter">(</span><a href="#sbt;TrapExit.getApp(cee478b19f).t" title="Thread">t</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(alternative: =&gt; Option[TrapExit.this.App])Option[TrapExit.this.App]">orElse</span> <a href="#sbt;TrapExit.getApp(0c624c493f)" title="(group: ThreadGroup)Option[TrapExit.this.App]">getApp</a><span class="delimiter">(</span><a href="#sbt;TrapExit.getApp(cee478b19f).t" title="Thread">t</a>.<span title="()ThreadGroup">getThreadGroup</span><span class="delimiter">)</span>

  <span class="comment">/** Gets the managed application associated with ThreadGroup `group` */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(group: ThreadGroup)Option[TrapExit.this.App]" id="sbt;TrapExit.getApp(0c624c493f)">getApp</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit.getApp(0c624c493f).group">group</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="Option[TrapExit.this.App]">Option</span><span class="delimiter">[</span>App<span class="delimiter">]</span> =
    <span title="(x: ThreadGroup)Option[ThreadGroup]">Option</span><span class="delimiter">(</span><a href="#sbt;TrapExit.getApp(0c624c493f).group" title="ThreadGroup">group</a><span class="delimiter">)</span>.<span title="(f: ThreadGroup =&gt; Option[TrapExit.this.App])Option[TrapExit.this.App]">flatMap</span><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit.getApp(0c624c493f).$anonfun.g">g</a> =&gt; <span title="(x: TrapExit.this.App)Option[TrapExit.this.App]">Option</span><span class="delimiter">(</span><a href="#sbt;TrapExit.threadToApp" title="java.util.concurrent.ConcurrentHashMap[sbt.TrapExit.ThreadID,TrapExit.this.App]">threadToApp</a>.<span title="(x$1: Any)TrapExit.this.App">get</span><span class="delimiter">(</span><a href="#sbt.TrapExit.computeID(9c897c8791)" title="(g: ThreadGroup)sbt.TrapExit.ThreadID">computeID</a><span class="delimiter">(</span><a href="#sbt;TrapExit.getApp(0c624c493f).$anonfun.g" title="ThreadGroup">g</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Handles a valid call to `System.exit` by setting the exit code and
   * interrupting remaining threads for the application associated with `t`, if one exists.
   */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(t: Thread, status: Int)Unit" id="sbt;TrapExit.exitApp">exitApp</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit.exitApp.t">t</a>: <span title="Thread">Thread</span>, <a title="Int" id="sbt;TrapExit.exitApp.status">status</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#sbt;TrapExit.getApp(cee478b19f)" title="(t: Thread)Option[TrapExit.this.App]">getApp</a><span class="delimiter">(</span><a href="#sbt;TrapExit.exitApp.t" title="Thread">t</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="None.type">None</span> =&gt; <span title="System.type">System</span>.<span title="java.io.PrintStream">err</span>.<span title="(x$1: String)Unit">println</span><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Could not exit(&quot;)">Could not exit($</span><a href="#sbt;TrapExit.exitApp.status" title="Int">status</a><span title="String(&quot;): no application associated with &quot;)">): no application associated with $</span><a href="#sbt;TrapExit.exitApp.t" title="Thread">t</a><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>
    <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="TrapExit.this.App" id="sbt;TrapExit.exitApp.a">a</a><span class="delimiter">)</span> =&gt;
      <a href="#sbt;TrapExit.exitApp.a" title="TrapExit.this.App">a</a>.<a href="#sbt;TrapExit;App.exitCode" title="=&gt; sbt.ExitCode">exitCode</a>.<a href="#sbt;ExitCode.set" title="(c: Int)Unit">set</a><span class="delimiter">(</span><a href="#sbt;TrapExit.exitApp.status" title="Int">status</a><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.stopAllThreads" title="(app: TrapExit.this.App)Unit">stopAllThreads</a><span class="delimiter">(</span><a href="#sbt;TrapExit.exitApp.a" title="TrapExit.this.App">a</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** SecurityManager hook to trap calls to `System.exit` to avoid shutting down the whole JVM.*/</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(status: Int)Unit" id="sbt;TrapExit.checkExit">checkExit</a><span class="delimiter">(</span><a title="Int" id="sbt;TrapExit.checkExit.status">status</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.active" title="=&gt; Boolean">active</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Thread" id="sbt;TrapExit.checkExit.t">t</a> = <span title="()Thread">currentThread</span>
    <span class="keyword">val</span> <a title="Array[StackTraceElement]" id="sbt;TrapExit.checkExit.stack">stack</a> = <a href="#sbt;TrapExit.checkExit.t" title="Thread">t</a>.<span title="()Array[StackTraceElement]">getStackTrace</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.checkExit.stack" title="Array[StackTraceElement]">stack</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">||</span> <a href="#sbt;TrapExit.checkExit.stack" title="(xs: Array[StackTraceElement])scala.collection.mutable.ArrayOps[StackTraceElement]">stack</a>.<span title="(p: StackTraceElement =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a href="#sbt;TrapExit.isRealExit" title="(element: StackTraceElement)Boolean">isRealExit</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#sbt;TrapExit.exitApp" title="(t: Thread, status: Int)Unit">exitApp</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkExit.t" title="Thread">t</a>, <a href="#sbt;TrapExit.checkExit.status" title="Int">status</a><span class="delimiter">)</span>
      <span title="Nothing" class="keyword">throw</span> <span title="sbt.TrapExitSecurityException" class="keyword">new</span> <a href="TrapExitSecurityException.scala.html#sbt;TrapExitSecurityException" title="sbt.TrapExitSecurityException">TrapExitSecurityException</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkExit.status" title="Int">status</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="comment">/** This ensures that only actual calls to exit are trapped and not just calls to check if exit is allowed.*/</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(element: StackTraceElement)Boolean" id="sbt;TrapExit.isRealExit">isRealExit</a><span class="delimiter">(</span><a title="StackTraceElement" id="sbt;TrapExit.isRealExit.element">element</a>: <span title="StackTraceElement">StackTraceElement</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> =
    <a href="#sbt;TrapExit.isRealExit.element" title="StackTraceElement">element</a>.<span title="()String">getClassName</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="String(&quot;java.lang.Runtime&quot;)" class="string">&quot;java.lang.Runtime&quot;</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#sbt;TrapExit.isRealExit.element" title="StackTraceElement">element</a>.<span title="()String">getMethodName</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="String(&quot;exit&quot;)" class="string">&quot;exit&quot;</span>

  <span class="comment">// These are overridden to do nothing because there is a substantial filesystem performance penalty</span>
  <span class="comment">// when there is a SecurityManager defined.  The default implementations of these construct a</span>
  <span class="comment">// FilePermission, and its initialization involves canonicalization, which is expensive.</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(file: String)Unit" id="sbt;TrapExit.checkRead(90cc6393d5)">checkRead</a><span class="delimiter">(</span><a title="String" id="sbt;TrapExit.checkRead(90cc6393d5).file">file</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(file: String, context: AnyRef)Unit" id="sbt;TrapExit.checkRead(87585d394c)">checkRead</a><span class="delimiter">(</span><a title="String" id="sbt;TrapExit.checkRead(87585d394c).file">file</a>: <span title="String">String</span>, <a title="AnyRef" id="sbt;TrapExit.checkRead(87585d394c).context">context</a>: <span title="AnyRef">AnyRef</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(file: String)Unit" id="sbt;TrapExit.checkWrite(90cc6393d5)">checkWrite</a><span class="delimiter">(</span><a title="String" id="sbt;TrapExit.checkWrite(90cc6393d5).file">file</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(file: String)Unit" id="sbt;TrapExit.checkDelete">checkDelete</a><span class="delimiter">(</span><a title="String" id="sbt;TrapExit.checkDelete.file">file</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(cmd: String)Unit" id="sbt;TrapExit.checkExec">checkExec</a><span class="delimiter">(</span><a title="String" id="sbt;TrapExit.checkExec.cmd">cmd</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(perm: java.security.Permission)Unit" id="sbt;TrapExit.checkPermission(77f050351f)">checkPermission</a><span class="delimiter">(</span><a title="java.security.Permission" id="sbt;TrapExit.checkPermission(77f050351f).perm">perm</a>: <span title="java.security.Permission">Permission</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a>.<span title="(x$1: java.security.Permission)Unit">checkPermission</span><span class="delimiter">(</span><a href="#sbt;TrapExit.checkPermission(77f050351f).perm" title="java.security.Permission">perm</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(perm: java.security.Permission, context: AnyRef)Unit" id="sbt;TrapExit.checkPermission(dd4ed42c3d)">checkPermission</a><span class="delimiter">(</span><a title="java.security.Permission" id="sbt;TrapExit.checkPermission(dd4ed42c3d).perm">perm</a>: <span title="java.security.Permission">Permission</span>, <a title="AnyRef" id="sbt;TrapExit.checkPermission(dd4ed42c3d).context">context</a>: <span title="AnyRef">AnyRef</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a>.<span title="(x$1: java.security.Permission, x$2: Any)Unit">checkPermission</span><span class="delimiter">(</span><a href="#sbt;TrapExit.checkPermission(dd4ed42c3d).perm" title="java.security.Permission">perm</a>, <a href="#sbt;TrapExit.checkPermission(dd4ed42c3d).context" title="AnyRef">context</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * SecurityManager hook that is abused to record every created Thread and associate it with a managed application.
   * This is not reliably called on different jvm implementations.  On openjdk and similar jvms, the Thread constructor
   * calls setPriority, which triggers this SecurityManager check.  For Java 6 on OSX, this is not called, however.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(t: Thread)Unit" id="sbt;TrapExit.checkAccess(92ff781945)">checkAccess</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit.checkAccess(92ff781945).t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.active" title="=&gt; Boolean">active</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="ThreadGroup" id="sbt;TrapExit.checkAccess(92ff781945).group">group</a> = <a href="#sbt;TrapExit.checkAccess(92ff781945).t" title="Thread">t</a>.<span title="()ThreadGroup">getThreadGroup</span>
      <a href="#sbt;TrapExit.noteAccess" title="(group: ThreadGroup)(f: TrapExit.this.App =&gt; Unit)Unit">noteAccess</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(92ff781945).group" title="ThreadGroup">group</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a title="TrapExit.this.App" id="sbt;TrapExit.checkAccess(92ff781945).$anonfun.app">app</a> =&gt;
        <a href="#sbt;TrapExit.checkAccess(92ff781945).$anonfun.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.register(aee7b3b88a)" title="(g: ThreadGroup)Unit">register</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(92ff781945).group" title="ThreadGroup">group</a><span class="delimiter">)</span>
        <a href="#sbt;TrapExit.checkAccess(92ff781945).$anonfun.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.register(92ff781945)" title="(t: Thread)Unit">register</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span>
        <a href="#sbt;TrapExit.checkAccess(92ff781945).$anonfun.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.register(92ff781945)" title="(t: Thread)Unit">register</a><span class="delimiter">(</span><span title="()Thread">currentThread</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a>.<span title="(x$1: Thread)Unit">checkAccess</span><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(92ff781945).t" title="Thread">t</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="comment">/**
   * This is specified to be called in every Thread's constructor and every time a ThreadGroup is created.
   * This allows us to reliably track every ThreadGroup that is created and map it back to the constructing application.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(tg: ThreadGroup)Unit" id="sbt;TrapExit.checkAccess(8baddbb783)">checkAccess</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit.checkAccess(8baddbb783).tg">tg</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.active" title="=&gt; Boolean">active</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit.isSystemGroup" title="(group: ThreadGroup)Boolean">isSystemGroup</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(8baddbb783).tg" title="ThreadGroup">tg</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#sbt;TrapExit.noteAccess" title="(group: ThreadGroup)(f: TrapExit.this.App =&gt; Unit)Unit">noteAccess</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(8baddbb783).tg" title="ThreadGroup">tg</a><span class="delimiter">)</span> <span class="delimiter">{</span> <a title="TrapExit.this.App" id="sbt;TrapExit.checkAccess(8baddbb783).$anonfun.app">app</a> =&gt;
        <a href="#sbt;TrapExit.checkAccess(8baddbb783).$anonfun.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.register(aee7b3b88a)" title="(g: ThreadGroup)Unit">register</a><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(8baddbb783).tg" title="ThreadGroup">tg</a><span class="delimiter">)</span>
        <a href="#sbt;TrapExit.checkAccess(8baddbb783).$anonfun.app" title="TrapExit.this.App">app</a>.<a href="#sbt;TrapExit;App.register(92ff781945)" title="(t: Thread)Unit">register</a><span class="delimiter">(</span><span title="()Thread">currentThread</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a> <span title="(x$1: AnyRef)Boolean">ne</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.delegateManager" title="SecurityManager">delegateManager</a>.<span title="(x$1: ThreadGroup)Unit">checkAccess</span><span class="delimiter">(</span><a href="#sbt;TrapExit.checkAccess(8baddbb783).tg" title="ThreadGroup">tg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(group: ThreadGroup)(f: TrapExit.this.App =&gt; Unit)Unit" id="sbt;TrapExit.noteAccess">noteAccess</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit.noteAccess.group">group</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="TrapExit.this.App =&gt; Unit" id="sbt;TrapExit.noteAccess.f">f</a>: App =&gt; Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#sbt;TrapExit.getApp(cee478b19f)" title="(t: Thread)Option[TrapExit.this.App]">getApp</a><span class="delimiter">(</span><span title="()Thread">currentThread</span><span class="delimiter">)</span> <span title="(alternative: =&gt; Option[TrapExit.this.App])Option[TrapExit.this.App]">orElse</span> <a href="#sbt;TrapExit.getApp(0c624c493f)" title="(group: ThreadGroup)Option[TrapExit.this.App]">getApp</a><span class="delimiter">(</span><a href="#sbt;TrapExit.noteAccess.group" title="ThreadGroup">group</a><span class="delimiter">)</span> <span title="(f: TrapExit.this.App =&gt; Unit)Unit">foreach</span> <a href="#sbt;TrapExit.noteAccess.f" title="TrapExit.this.App =&gt; Unit">f</a>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(group: ThreadGroup)Boolean" id="sbt;TrapExit.isSystemGroup">isSystemGroup</a><span class="delimiter">(</span><a title="ThreadGroup" id="sbt;TrapExit.isSystemGroup.group">group</a>: <span title="ThreadGroup">ThreadGroup</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> =
    <span class="delimiter">(</span><a href="#sbt;TrapExit.isSystemGroup.group" title="ThreadGroup">group</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.isSystemGroup.group" title="ThreadGroup">group</a>.<span title="()String">getName</span> <span title="(x$1: AnyRef)Boolean">==</span> <span title="String(&quot;system&quot;)" class="string">&quot;system&quot;</span><span class="delimiter">)</span>

  <span class="comment">/** `true` if there is at least one application currently being managed. */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="sbt;TrapExit.active">active</a> = <a href="#sbt;TrapExit.running" title="java.util.concurrent.atomic.AtomicInteger">running</a>.<span title="()Int">get</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(log: sbt.Logger)Unit" id="sbt;TrapExit.disposeAllFrames">disposeAllFrames</a><span class="delimiter">(</span><a title="sbt.Logger" id="sbt;TrapExit.disposeAllFrames.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[java.awt.Frame]" id="sbt;TrapExit.disposeAllFrames.allFrames">allFrames</a> = java.awt.<span title="java.awt.Frame.type">Frame</span>.<span title="()Array[java.awt.Frame]">getFrames</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.disposeAllFrames.allFrames" title="(xs: Array[java.awt.Frame])scala.collection.mutable.ArrayOps[java.awt.Frame]">allFrames</a>.<span title="=&gt; Boolean">nonEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#sbt;TrapExit.disposeAllFrames.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Disposing &quot;)">Disposing $</span><span class="delimiter">{</span><a href="#sbt;TrapExit.disposeAllFrames.allFrames" title="Array[java.awt.Frame]">allFrames</a>.<span title="=&gt; Int">length</span><span class="delimiter">}</span><span title="String(&quot; top-level windows...&quot;)" class="string"> top-level windows...&quot;</span><span class="delimiter">)</span>
      <a href="#sbt;TrapExit.disposeAllFrames.allFrames" title="(xs: Array[java.awt.Frame])scala.collection.mutable.ArrayOps[java.awt.Frame]">allFrames</a>.<span title="(f: java.awt.Frame =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#sbt;TrapExit.disposeAllFrames.$anonfun.x$7" title="java.awt.Frame">_</a>.<span title="()Unit">dispose</span><span class="delimiter">)</span> <span class="comment">// dispose all top-level windows, which will cause the AWT-EventQueue-* threads to exit</span>
      <span class="keyword">val</span> <a title="Int" id="sbt;TrapExit.disposeAllFrames.waitSeconds">waitSeconds</a> = <span title="Int(2)" class="int">2</span>
      <a href="#sbt;TrapExit.disposeAllFrames.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Waiting &quot;)">Waiting $</span><a href="#sbt;TrapExit.disposeAllFrames.waitSeconds" title="Int">waitSeconds</a><span title="String(&quot; s to let AWT thread exit.&quot;)" class="string"> s to let AWT thread exit.&quot;</span><span class="delimiter">)</span>
      <span title="Thread.type">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#sbt;TrapExit.disposeAllFrames.waitSeconds" title="Int">waitSeconds</a> <span title="=&gt; Long">*</span> <span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span> <span class="comment">// AWT Thread doesn't exit immediately, so wait to interrupt it</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  <span class="comment">/** Returns true if the given thread is in the 'system' thread group or is an AWT thread other than AWT-EventQueue.*/</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(t: Thread)Boolean" id="sbt;TrapExit.isSystemThread">isSystemThread</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit.isSystemThread.t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span> =
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt;TrapExit.isSystemThread.t" title="Thread">t</a>.<span title="()String">getName</span>.<span title="(x$1: String)Boolean">startsWith</span><span class="delimiter">(</span><span title="String(&quot;AWT-&quot;)" class="string">&quot;AWT-&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="=&gt; Boolean">!</span><a href="#sbt;TrapExit.isEventQueue" title="(t: Thread)Boolean">isEventQueue</a><span class="delimiter">(</span><a href="#sbt;TrapExit.isSystemThread.t" title="Thread">t</a><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#sbt;TrapExit.isSystemGroup" title="(group: ThreadGroup)Boolean">isSystemGroup</a><span class="delimiter">(</span><a href="#sbt;TrapExit.isSystemThread.t" title="Thread">t</a>.<span title="()ThreadGroup">getThreadGroup</span><span class="delimiter">)</span>

  <span class="comment">/**
   * An App is identified as using AWT if it gets associated with the event queue thread.
   * The event queue thread is not treated as a system thread.
   */</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(t: Thread)Boolean" id="sbt;TrapExit.isEventQueue">isEventQueue</a><span class="delimiter">(</span><a title="Thread" id="sbt;TrapExit.isEventQueue.t">t</a>: <span title="Thread">Thread</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#sbt;TrapExit.isEventQueue.t" title="Thread">t</a>.<span title="()String">getName</span>.<span title="(x$1: String)Boolean">startsWith</span><span class="delimiter">(</span><span title="String(&quot;AWT-EventQueue&quot;)" class="string">&quot;AWT-EventQueue&quot;</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/** A thread-safe, write-once, optional cell for tracking an application's exit code.*/</span>
<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ExitCode extends AnyRef" id="sbt;ExitCode">ExitCode</a> <a href="#sbt;ExitCode" title="sbt.ExitCode" class="delimiter">{</a>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Option[Int]" id="sbt;ExitCode.code_=">code</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="None.type">None</span>
  <span class="keyword">def</span> <a title="(c: Int)Unit" id="sbt;ExitCode.set">set</a><span class="delimiter">(</span><a title="Int" id="sbt;ExitCode.set.c">c</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#sbt;ExitCode" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span> <a href="#sbt;ExitCode.code_=" title="(x$1: Option[Int])Unit">code</a> = <a href="#sbt;ExitCode.code_=" title="=&gt; Option[Int]">code</a> <span title="(alternative: =&gt; Option[Int])Option[Int]">orElse</span> <span title="(x: Int)Some[Int]">Some</span><span class="delimiter">(</span><a href="#sbt;ExitCode.set.c" title="Int">c</a><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; Option[Int]" id="sbt;ExitCode.value">value</a>: <span title="Option[Int]">Option</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <a href="#sbt;ExitCode" title="(x$1: Option[Int])Option[Int]">synchronized</a> <span class="delimiter">{</span> <a href="#sbt;ExitCode.code_=" title="=&gt; Option[Int]">code</a> <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * The default uncaught exception handler for managed executions.
 * It logs the thread and the exception.
 */</span>
<span title="AnyRef" class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class LoggingExceptionHandler extends Object with Thread.UncaughtExceptionHandler" id="sbt;LoggingExceptionHandler">LoggingExceptionHandler</a><a href="#sbt;LoggingExceptionHandler" title="sbt.LoggingExceptionHandler" class="delimiter">(</a><a title="sbt.Logger" id="sbt;LoggingExceptionHandler.log">log</a>: <a href="Logger.scala.html#sbt;Logger" title="sbt.Logger">Logger</a>, <a title="Option[Thread.UncaughtExceptionHandler]" id="sbt;LoggingExceptionHandler.delegate">delegate</a>: <span title="Option[Thread.UncaughtExceptionHandler]">Option</span><span class="delimiter">[</span>Thread.UncaughtExceptionHandler<span class="delimiter">]</span><span class="delimiter">)</span> <span class="keyword">extends</span> Thread.<span title="Thread.UncaughtExceptionHandler">UncaughtExceptionHandler</span> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="(t: Thread, e: Throwable)Unit" id="sbt;LoggingExceptionHandler.uncaughtException">uncaughtException</a><span class="delimiter">(</span><a title="Thread" id="sbt;LoggingExceptionHandler.uncaughtException.t">t</a>: <span title="Thread">Thread</span>, <a title="Throwable" id="sbt;LoggingExceptionHandler.uncaughtException.e">e</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#sbt;LoggingExceptionHandler.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.error(83d3728a3c)" title="(message: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;(&quot;)" class="string">&quot;(&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt;LoggingExceptionHandler.uncaughtException.t" title="Thread">t</a>.<span title="()String">getName</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;) &quot;)" class="string">&quot;) &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#sbt;LoggingExceptionHandler.uncaughtException.e" title="Throwable">e</a>.<span title="()String">toString</span><span class="delimiter">)</span>
    <a href="#sbt;LoggingExceptionHandler.log" title="sbt.Logger">log</a>.<a href="Logger.scala.html#sbt;Logger.trace(5f37c81d43)" title="(t: =&gt; Throwable)Unit">trace</a><span class="delimiter">(</span><a href="#sbt;LoggingExceptionHandler.uncaughtException.e" title="Throwable">e</a><span class="delimiter">)</span>
    <a href="#sbt;LoggingExceptionHandler.delegate" title="Option[Thread.UncaughtExceptionHandler]">delegate</a>.<span title="(f: Thread.UncaughtExceptionHandler =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#sbt;LoggingExceptionHandler.uncaughtException.$anonfun.x$8" title="Thread.UncaughtExceptionHandler">_</a>.<span title="(x$1: Thread, x$2: Throwable)Unit">uncaughtException</span><span class="delimiter">(</span><a href="#sbt;LoggingExceptionHandler.uncaughtException.t" title="Thread">t</a>, <a href="#sbt;LoggingExceptionHandler.uncaughtException.e" title="Throwable">e</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
