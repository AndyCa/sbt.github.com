<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>sbt/classpath/ClassLoaderCache.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> sbt.classpath

<span class="keyword">import</span> java.lang.ref.<span class="delimiter">{</span> Reference, SoftReference <span class="delimiter">}</span>
<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.net.URLClassLoader
<span class="keyword">import</span> java.util.HashMap

<span class="comment">// Hack for testing only</span>
<span class="keyword">private</span><span class="delimiter">[</span>sbt<span class="delimiter">]</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class ClassLoaderCache extends AnyRef" id="sbt.classpath;ClassLoaderCache">ClassLoaderCache</a><a href="#sbt.classpath;ClassLoaderCache" title="sbt.classpath.ClassLoaderCache" class="delimiter">(</a><span class="keyword">val</span> <a title="ClassLoader" id="sbt.classpath;ClassLoaderCache.commonParent">commonParent</a>: <span title="ClassLoader">ClassLoader</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">val</span> <a title="java.util.HashMap[List[java.io.File],java.lang.ref.Reference[sbt.classpath.CachedClassLoader]]" id="sbt.classpath;ClassLoaderCache.delegate">delegate</a> = <span title="()java.util.HashMap[List[java.io.File],java.lang.ref.Reference[sbt.classpath.CachedClassLoader]]" class="keyword">new</span> <span title="java.util.HashMap[List[java.io.File],java.lang.ref.Reference[sbt.classpath.CachedClassLoader]]">HashMap</span><span class="delimiter">[</span>List<span class="delimiter">[</span>File<span class="delimiter">]</span>, Reference<span class="delimiter">[</span>CachedClassLoader<span class="delimiter">]</span><span class="delimiter">]</span>

  <span class="comment">/**
   * Returns a ClassLoader with `commonParent` as a parent and that will load classes from classpath `files`.
   * The returned ClassLoader may be cached from a previous call if the last modified time of all `files` is unchanged.
   * This method is thread-safe.
   */</span>
  <span class="keyword">def</span> <a title="(files: List[java.io.File])ClassLoader" id="sbt.classpath;ClassLoaderCache.apply">apply</a><span class="delimiter">(</span><a title="List[java.io.File]" id="sbt.classpath;ClassLoaderCache.apply.files">files</a>: <span title="List[java.io.File]">List</span><span class="delimiter">[</span>File<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="ClassLoader">ClassLoader</span> = <a href="#sbt.classpath;ClassLoaderCache" title="(x$1: ClassLoader)ClassLoader">synchronized</a> <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="List[Long]" id="sbt.classpath;ClassLoaderCache.apply.tstamps">tstamps</a> = <a href="#sbt.classpath;ClassLoaderCache.apply.files" title="List[java.io.File]">files</a>.<span title="(f: java.io.File =&gt; Long)(implicit bf: scala.collection.generic.CanBuildFrom[List[java.io.File],Long,List[Long]])List[Long]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,Long,List[Long]]" class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.apply.tstamps.$anonfun.x$1" title="java.io.File">_</a>.<span title="()Long">lastModified</span><span class="delimiter">)</span>
    <a href="#sbt.classpath;ClassLoaderCache.getFromReference" title="(files: List[java.io.File], stamps: List[Long], existingRef: java.lang.ref.Reference[sbt.classpath.CachedClassLoader])ClassLoader">getFromReference</a><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.apply.files" title="List[java.io.File]">files</a>, <a href="#sbt.classpath;ClassLoaderCache.apply.tstamps" title="List[Long]">tstamps</a>, <a href="#sbt.classpath;ClassLoaderCache.delegate" title="java.util.HashMap[List[java.io.File],java.lang.ref.Reference[sbt.classpath.CachedClassLoader]]">delegate</a>.<span title="(x$1: Any)java.lang.ref.Reference[sbt.classpath.CachedClassLoader]">get</span><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.apply.files" title="List[java.io.File]">files</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(files: List[java.io.File], stamps: List[Long], existingRef: java.lang.ref.Reference[sbt.classpath.CachedClassLoader])ClassLoader" id="sbt.classpath;ClassLoaderCache.getFromReference">getFromReference</a><span class="delimiter">(</span><a title="List[java.io.File]" id="sbt.classpath;ClassLoaderCache.getFromReference.files">files</a>: <span title="List[java.io.File]">List</span><span class="delimiter">[</span>File<span class="delimiter">]</span>, <a title="List[Long]" id="sbt.classpath;ClassLoaderCache.getFromReference.stamps">stamps</a>: <span title="List[Long]">List</span><span class="delimiter">[</span>Long<span class="delimiter">]</span>, <a title="java.lang.ref.Reference[sbt.classpath.CachedClassLoader]" id="sbt.classpath;ClassLoaderCache.getFromReference.existingRef">existingRef</a>: <span title="java.lang.ref.Reference[sbt.classpath.CachedClassLoader]">Reference</span><span class="delimiter">[</span>CachedClassLoader<span class="delimiter">]</span><span class="delimiter">)</span> =
    <span title="ClassLoader" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.getFromReference.existingRef" title="java.lang.ref.Reference[sbt.classpath.CachedClassLoader]">existingRef</a> <span title="(x$1: AnyRef)Boolean">eq</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
      <a href="#sbt.classpath;ClassLoaderCache.newEntry" title="(files: List[java.io.File], stamps: List[Long])ClassLoader">newEntry</a><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.getFromReference.files" title="List[java.io.File]">files</a>, <a href="#sbt.classpath;ClassLoaderCache.getFromReference.stamps" title="List[Long]">stamps</a><span class="delimiter">)</span>
    <span class="keyword">else</span>
      <a href="#sbt.classpath;ClassLoaderCache.get" title="(files: List[java.io.File], stamps: List[Long], existing: sbt.classpath.CachedClassLoader)ClassLoader">get</a><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.getFromReference.files" title="List[java.io.File]">files</a>, <a href="#sbt.classpath;ClassLoaderCache.getFromReference.stamps" title="List[Long]">stamps</a>, <a href="#sbt.classpath;ClassLoaderCache.getFromReference.existingRef" title="java.lang.ref.Reference[sbt.classpath.CachedClassLoader]">existingRef</a>.<span title="()sbt.classpath.CachedClassLoader">get</span><span class="delimiter">)</span>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(files: List[java.io.File], stamps: List[Long], existing: sbt.classpath.CachedClassLoader)ClassLoader" id="sbt.classpath;ClassLoaderCache.get">get</a><span class="delimiter">(</span><a title="List[java.io.File]" id="sbt.classpath;ClassLoaderCache.get.files">files</a>: <span title="List[java.io.File]">List</span><span class="delimiter">[</span>File<span class="delimiter">]</span>, <a title="List[Long]" id="sbt.classpath;ClassLoaderCache.get.stamps">stamps</a>: <span title="List[Long]">List</span><span class="delimiter">[</span>Long<span class="delimiter">]</span>, <a title="sbt.classpath.CachedClassLoader" id="sbt.classpath;ClassLoaderCache.get.existing">existing</a>: <a href="#sbt.classpath;CachedClassLoader" title="sbt.classpath.CachedClassLoader">CachedClassLoader</a><span class="delimiter">)</span>: <span title="ClassLoader">ClassLoader</span> =
    <span title="ClassLoader" class="keyword">if</span> <span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.get.existing" title="sbt.classpath.CachedClassLoader">existing</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span> <span title="(x: Boolean)Boolean">||</span> <a href="#sbt.classpath;ClassLoaderCache.get.stamps" title="List[Long]">stamps</a> <span title="(x$1: AnyRef)Boolean">!=</span> <a href="#sbt.classpath;ClassLoaderCache.get.existing" title="sbt.classpath.CachedClassLoader">existing</a>.<a href="#sbt.classpath;CachedClassLoader.timestamps" title="=&gt; List[Long]">timestamps</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#sbt.classpath;ClassLoaderCache.newEntry" title="(files: List[java.io.File], stamps: List[Long])ClassLoader">newEntry</a><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.get.files" title="List[java.io.File]">files</a>, <a href="#sbt.classpath;ClassLoaderCache.get.stamps" title="List[Long]">stamps</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span>
      <a href="#sbt.classpath;ClassLoaderCache.get.existing" title="sbt.classpath.CachedClassLoader">existing</a>.<a href="#sbt.classpath;CachedClassLoader.loader" title="=&gt; ClassLoader">loader</a>

  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="(files: List[java.io.File], stamps: List[Long])ClassLoader" id="sbt.classpath;ClassLoaderCache.newEntry">newEntry</a><span class="delimiter">(</span><a title="List[java.io.File]" id="sbt.classpath;ClassLoaderCache.newEntry.files">files</a>: <span title="List[java.io.File]">List</span><span class="delimiter">[</span>File<span class="delimiter">]</span>, <a title="List[Long]" id="sbt.classpath;ClassLoaderCache.newEntry.stamps">stamps</a>: <span title="List[Long]">List</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="ClassLoader">ClassLoader</span> =
    <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.net.URLClassLoader" id="sbt.classpath;ClassLoaderCache.newEntry.loader">loader</a> = <span title="java.net.URLClassLoader" class="keyword">new</span> <span title="java.net.URLClassLoader">URLClassLoader</span><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.newEntry.files" title="List[java.io.File]">files</a>.<span title="(f: java.io.File =&gt; java.net.URL)(implicit bf: scala.collection.generic.CanBuildFrom[List[java.io.File],java.net.URL,List[java.net.URL]])List[java.net.URL]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,java.net.URL,List[java.net.URL]]" class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.newEntry.loader.$anonfun.x$2" title="java.io.File">_</a>.<span title="()java.net.URI">toURI</span>.<span title="()java.net.URL">toURL</span><span class="delimiter">)</span>.<span title="(implicit evidence$1: scala.reflect.ClassTag[java.net.URL])Array[java.net.URL]">toArray</span>, <a href="#sbt.classpath;ClassLoaderCache.commonParent" title="=&gt; ClassLoader">commonParent</a><span class="delimiter">)</span>
      <a href="#sbt.classpath;ClassLoaderCache.delegate" title="java.util.HashMap[List[java.io.File],java.lang.ref.Reference[sbt.classpath.CachedClassLoader]]">delegate</a>.<span title="(x$1: List[java.io.File], x$2: java.lang.ref.Reference[sbt.classpath.CachedClassLoader])java.lang.ref.Reference[sbt.classpath.CachedClassLoader]">put</span><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.newEntry.files" title="List[java.io.File]">files</a>, <span title="java.lang.ref.SoftReference[sbt.classpath.CachedClassLoader]" class="keyword">new</span> <span title="java.lang.ref.SoftReference[sbt.classpath.CachedClassLoader]">SoftReference</span><span class="delimiter">(</span><span title="sbt.classpath.CachedClassLoader" class="keyword">new</span> <a href="#sbt.classpath;CachedClassLoader" title="sbt.classpath.CachedClassLoader">CachedClassLoader</a><span class="delimiter">(</span><a href="#sbt.classpath;ClassLoaderCache.newEntry.loader" title="java.net.URLClassLoader">loader</a>, <a href="#sbt.classpath;ClassLoaderCache.newEntry.files" title="List[java.io.File]">files</a>, <a href="#sbt.classpath;ClassLoaderCache.newEntry.stamps" title="List[Long]">stamps</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#sbt.classpath;ClassLoaderCache.newEntry.loader" title="java.net.URLClassLoader">loader</a>
    <span class="delimiter">}</span>
<span class="delimiter">}</span>
<span title="AnyRef" class="keyword">private</span><span class="delimiter">[</span>sbt<span class="delimiter">]</span> <span class="keyword">final</span> <span class="keyword">class</span> <a title="class CachedClassLoader extends AnyRef" id="sbt.classpath;CachedClassLoader">CachedClassLoader</a><a href="#sbt.classpath;CachedClassLoader" title="sbt.classpath.CachedClassLoader" class="delimiter">(</a><span class="keyword">val</span> <a title="ClassLoader" id="sbt.classpath;CachedClassLoader.loader">loader</a>: <span title="ClassLoader">ClassLoader</span>, <span class="keyword">val</span> <a title="List[java.io.File]" id="sbt.classpath;CachedClassLoader.files">files</a>: <span title="List[java.io.File]">List</span><span class="delimiter">[</span>File<span class="delimiter">]</span>, <span class="keyword">val</span> <a title="List[Long]" id="sbt.classpath;CachedClassLoader.timestamps">timestamps</a>: <span title="List[Long]">List</span><span class="delimiter">[</span>Long<span class="delimiter">]</span><span class="delimiter">)</span>

        </pre>
    </body>
</html>
